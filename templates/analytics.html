<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Analytics — SpendWise</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='analytics.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="simple-page">
  <header class="simple-header">
    <div class="nav-left">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="logo" class="logo" />
      <a href="{{ url_for('home') }}" class="brand">SpendWise</a>
  </div>
    <div class="header-actions">
      <a href="/" class="btn">Home</a>
      <a href="/view-expense-page" class="btn">View Expenses</a>
      <a href="/add-expense-page" class="btn">Add Expense</a>
      <a href="/add-income" class="btn">Add Income</a>
    </div>
  </header>

  <main class="container">
    {# Runtime analytics errors appear here; toggled via analytics.js #}
    <div id="analyticsError" class="msg error" style="display:none;margin-bottom:12px;"></div>
    <section class="summary-cards">
      <div class="card">
        <h3>Total Spent</h3>
        <div id="total-spent">—</div>
      </div>
      <div class="card">
        <h3>Prediction (next month)</h3>
        <div id="prediction">—</div>
      </div>
      <div class="card">
        <h3>Top Merchant</h3>
        <div id="top-merchant">—</div>
      </div>
    </section>

    <section class="charts">
      <div class="chart-card">
        <h4>Spending by Category</h4>
        <canvas id="categoryChart" width="400" height="240"></canvas>
      </div>
      <div class="chart-card">
        <h4>Monthly Trend</h4>
        <canvas id="monthlyChart" width="600" height="240"></canvas>
      </div>
    </section>

    <section class="report-actions">
      <button id="download-expenses" class="btn2">Download Expenses CSV</button>
      <button id="download-summary" class="btn2">Download Summary CSV</button>
    </section>
  </main>

  <script src="{{ url_for('static', filename='analytics.js') }}"></script>
  <script>
    // small initializer for analytics page
    document.addEventListener('DOMContentLoaded', function(){
      const errEl = document.getElementById('analyticsError');
      function showError(msg){ if(errEl){ errEl.style.display='block'; errEl.textContent = msg; } }

      if (typeof loadAnalytics === 'function') {
        try{
          loadAnalytics();
        }catch(e){ showError('Analytics load error: '+ e.message); console.error(e); }
      }

      document.getElementById('download-expenses').addEventListener('click', function(){
        // trigger download via browser navigation to report endpoint
        const token = localStorage.getItem('token');
        const url = '/api/reports?type=expenses&format=csv';
        if (token) {
          fetch(url, {headers: {'Authorization': 'Bearer ' + token}})
            .then(r => { if(!r.ok) throw new Error('Download failed: ' + r.status); return r.blob(); })
            .then(blob => {
              const link = document.createElement('a');
              link.href = window.URL.createObjectURL(blob);
              link.download = 'expenses.csv';
              link.click();
            }).catch(e=>{ showError(e.message); });
        } else {
          // fallback: open url which should return CSV via cookies
          window.location = url;
        }
      });

      document.getElementById('download-summary').addEventListener('click', function(){
        const token = localStorage.getItem('token');
        const url = '/api/reports?type=summary&format=csv';
        if (token) {
          fetch(url, {headers: {'Authorization': 'Bearer ' + token}})
            .then(r => { if(!r.ok) throw new Error('Download failed: ' + r.status); return r.blob(); })
            .then(blob => {
              const link = document.createElement('a');
              link.href = window.URL.createObjectURL(blob);
              link.download = 'summary.csv';
              link.click();
            }).catch(e=>{ showError(e.message); });
        } else {
          window.location = url;
        }
      });
    });
  </script>
</body>

</html>
